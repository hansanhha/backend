[도커 이미지](#도커-이미지)

[레지스트리](#레지스트리)

[이미지 레이어](#이미지-레이어)

[환경 변수](#환경-변수)

[이미지 태그](#이미지-태그)

[도커 파일 명령어](#도커-파일-명령어)

[컨테이너 이미지 빌드](#컨테이너-이미지-빌드)

## 도커 이미지

도커 이미지는 컨테이너를 실행하기 위한 읽기 전용 템플릿임

이미지는 애플리케이션이 실행되는 환경을 정의하며, 필요한 모든 파일, 설정, 의존성, 환경 변수 등을 포함하고 있음

이미지는 레이어로 구성되어 있으며, 이를 기반으로 컨테이너를 생성하고 실행함

도커 이미지는 일반적으로 Dockderfile을 사용해 빌드됨

Dockerfile은 이미지의 빌드 과정을 정의한 스크립트 파일로, 이미지에 포함될 내용, 설치할 패키지, 설정할 환경 변수 등을 기술함

## 레지스트리

레지스트리는 도커 이미지를 업로드하고 다운로드할 수 있는 공간으로

Docker Hub와 같은 공개 레지스트리와 기업이나 팀에서 내부적으로 사용하기 위한 프라이빗 레지스트리로 나뉨

## 이미지 레이어

도커 이미지는 물리적으로 작은 여러 개의 파일로 구성되어 있음

레지스트리에서 이미지를 다운받을 때 하나의 파일이 아닌 여러 파일을 받는데, 이들 각각의 파일이 이미지 레이어임

도커가 이들 파일을 조립해 컨테이너의 내부 파일 시스템을 만드는데, 모든 레이어를 내려받고 나면 전체 이미지를 사용할 수 있게 됨

```text
> docker image history simple-dockerfile
IMAGE          CREATED          CREATED BY                                       SIZE      COMMENT
3a5fa0027217   21 minutes ago   CMD ["node" "/web-ping/app.js"]                  0B        buildkit.dockerfile.v0
<missing>      21 minutes ago   COPY app.js . # buildkit                         1.01kB    buildkit.dockerfile.v0
<missing>      29 minutes ago   WORKDIR /web-ping                                0B        buildkit.dockerfile.v0
<missing>      29 minutes ago   ENV INTERVAL=3000                                0B        buildkit.dockerfile.v0
```

위의 `docker image history`는 각 레이어가 무엇이고 이들 레이어가 어떤 명령으로 빌드됐는지 알 수 있는 명령어임

한 줄마다 한 레이어에 대한 정보가 출력됨

CREATE BY 항목은 해당 레이어를 구성한 도커 파일 스크립트의 명령어임

도커 파일 명령어와 이미지 레이어는 1:1 관계를 가짐

#### 이미지 레이어 구조

도커 이미지는 이미지 레이어가 모인 논리적 대상임

레이어는 도커 엔진의 캐시에 물리적으로 저장된 파일로, 이미지의 각 레이어는 아래 레이어의 스냅샷이며, 상위 레이어는 하위 레이어를 확장함

이 구조는 이미지 간에 레이어를 재사용할 수 있게 하고, 저장 공간을 절약하며 이미지 빌드 시간을 단축하게 함

서로 다른 이미지(애플리케이션)여도 동일한 이미지 레이어를 사용하면 도커 엔진에 캐시된 이미지 레이어를 공유함 -> 그만큼 디스크 공간이 절약됨

#### 이미지 빌드 최적화

도커 파일 스크립트의 명령어가 각각 하나의 이미지 레이어와 1대1 연결되므로, 명령어의 결과가 이전 빌드와 같다면 이전에 캐시된 레이어를 재사용함

도커는 캐시에 일치하는 레이어가 있는지 확인하기 위해 해시값을 이용함 

해시값은 도커 파일 스크립트의 명령어와 명령어에 의해 복사되는 파일의 내용으로부터 계산되는데, 기존 이미지 레이어에 해시값이 일치하는 것이 없다면 캐시 미스가 발생하여 레이어를 재사용하는 대신 해당 명령어가 실행됨

한 번 명령어가 실행되면 그 뒤에 오는 명령어는 수정되는 것이 없더라도 모두 실행됨

**따라서 잘 수정되지 않는 명령어는 앞으로 오고, 자주 수정되는 명령어는 뒤에 오도록 배치돼야 함**

## 환경 변수

환경 변수는 운영체제에서 제공하는 키-값 쌍임

윈도우나 리눅스에서 환경 변수를 사용할 수 있듯이, 도커 컨테이너도 자체적인 별도의 환경 변수를 가짐

도커 이미지는 설정값의 기본값을 포함해 패키징되지만 컨테이너를 실행할 때 이 설정값을 바꿀 수 있어야 함

도커 컨테이너의 환경변수를 이용하면 간단하게 설정값을 바꿔 애플리케이션의 동작을 의도한대로 변경할 수 있음

동일한 이미지를 가지고도 설정값에 의해 동작을 다르게 할 수도 있음

즉, 애플리케이션의 설정값을 컨테이너에서 받도록하여 다른 환경에도 애플리케이션을 배포할 수 있도록 이식성 있는 이미지를 만들 수 있어야 함

## 이미지 태그

도커 이미지는 태그를 사용하여 특정 버전을 식별할 수 있음

`ubuntu:20.04` 라는 이미지에서 `ubuntu`는 이미지 이름이고, `20.04`는 태그임

태그는 이미지를 버전 별로 관리하는 데 유용하며, `latest` 태그는 최신 버전을 나타내는 데 자주 사용됨

## 도커 파일 명령어

#### FROM

베이스 이미지를 지정함

`FROM ubuntu:20.04`

#### RUN

이미지 빌드 시 실행할 명령어를 지정함

`RUN apt-get update && apt-get install -y git`

#### ENV

환경 변수 값을 설정함

값을 지정하기 위해 [key]=[value] 형식을 따름

```Dockerfile
ENV USER=ubuntu-user
ENV HOME=/home/$USER
```

#### WORKDIR

컨테이너 이미지 파일 시스템에 디렉토리를 만들고, 해당 디렉토리를 작업 디렉토리로 지정하는 명령어임

리눅스와 윈도우 컨테이너 모두 구분자로 슬래시(/)를 사용함

#### COPY

로컬 파일 시스템(호스트)의 파일 또는 디렉토리를 컨테이너 이미지로 복사함

[원본 경로] [복사 경로] 형식으로 지정하면 됨

`COPY . /app

#### CMD

컨테이너 실행 시 기본적으로 실행할 명령어를 지정함

`CMD ["python", "app.py"]

## 컨테이너 이미지 빌드

이미지를 빌드하려면 다음과 같은 것들이 필요함
- 도커 파일
- 이미지 이름, 이미지 태그
- 패키징에 필요한 파일의 경로

`docker image build -t <image_name>:<tag> <file_path>`

tag를 별도로 명시하지 않는 경우 `latest` 태그가 자동적으로 붙음

도커 파일 및 이미지에 포함시킬 파일이 위치한 경로를 도커에서는 컨텍스트라고 함

```
// 현재 파일 경로에 도커 이미지를 빌드하는 경우의 명령어

docker image build -t simple-image:0.0.1 .